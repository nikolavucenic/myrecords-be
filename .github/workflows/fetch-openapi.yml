name: Fetch OpenAPI Spec

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  fetch-swagger:
    runs-on: ubuntu-latest

    steps:
      - name: Wait for deployed backend to be ready
        run: |
          echo "Waiting for the backend to be ready..."
          for i in {1..20}; do
            if curl --fail --silent http://myrecords-be-production.up.railway.app/v3/api-docs; then
              echo "Backend is up!"
              break
            fi
            echo "Attempt $i: Not ready yet..."
            sleep 10
          done

      - name: Fetch openapi.json
        run: |
          curl http://myrecords-be-production.up.railway.app/v3/api-docs -o openapi.json
          echo "âœ… openapi.json fetched"

      - name: Upload openapi.json as artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: openapi.json